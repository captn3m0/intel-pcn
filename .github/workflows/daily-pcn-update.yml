name: Daily PCN Database Update

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update-pcn-database:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-python@v5
    

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
    - name: Download last latest release pcn.db as old.db
      run: wget "${{github.server_url}}/${{github.repository}}/releases/latest/download/pcn.db" -O old.db
    - name: Build Database
      run: pip install -r requirements.txt && python _scripts/init.py
    - name: Check database and compare fingerprints
      id: compare
      run: |
        if [ ! -f pcn.db ]; then
          echo "Error: pcn.db was not created"
          exit 1
        fi
        echo "Database size: $(stat -f%z pcn.db 2>/dev/null || stat -c%s pcn.db) bytes"
        echo $(sqlite3 pcn.db "SELECT COUNT(*) FROM pcns") ROWS
        
        old_fingerprint=$(sqlite3 old.db "SELECT MAX(createddate)/1000, COUNT(*) FROM pcns")
        new_fingerprint=$(sqlite3 pcn.db "SELECT MAX(createddate)/1000, COUNT(*) FROM pcns")
        
        echo "Old database fingerprint: $old_fingerprint"
        echo "New database fingerprint: $new_fingerprint"
        
        pcn_count=$(sqlite3 pcn.db "SELECT COUNT(*) FROM pcns")
        echo "count=$pcn_count" >> $GITHUB_OUTPUT
        
        if [ "$old_fingerprint" == "$new_fingerprint" ]; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "Database fingerprints match - skipping release"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Database fingerprints differ - proceeding with release"
        fi
        
    - name: Create release
      uses: softprops/action-gh-release@v2
      id: create_release
      if: steps.compare.outputs.changed == 'true'
      with:
        tag_name: ${{ steps.date.outputs.date }}
        name: PCN Database - ${{ steps.date.outputs.date }}
        body: |
          Daily Intel PCN database update for ${{ steps.date.outputs.date }}
          
          This release contains the latest Intel PCN Data
          
          **Database Stats:**
          - Generated: ${{ steps.date.outputs.date }}
          - File: `pcn.db` (SQLite database)
          - PCN Count: ${{ steps.compare.outputs.count }}
          
          **Usage:**
          - Download `pcn.db` to query PCN data locally
          - Website: [Intel PCN Database](https://intel.pcn.captnemo.in/)
        files: |
          pcn.db
        generate_release_notes: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Trigger Netlify build
      if: steps.compare.outputs.changed == 'true' && steps.create_release.conclusion == 'success'
      run: |
        curl -X POST -d {} "${{ secrets.NETLIFY_BUILD_URL }}"