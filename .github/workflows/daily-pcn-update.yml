name: Daily PCN Database Update

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update-pcn-database:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-python@v5
    - run: python _scripts/init.py
      
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
      
    - name: Check if database was created
      run: |
        if [ ! -f pcn.db ]; then
          echo "Error: pcn.db was not created"
          exit 1
        fi
        echo "Database size: $(stat -f%z pcn.db 2>/dev/null || stat -c%s pcn.db) bytes"
        echo $(sqlite3 pcn.db "SELECT COUNT(*) FROM pcns") ROWS
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      id: create_release
      with:
        tag_name: ${{ steps.date.outputs.date }}
        name: PCN Database - ${{ steps.date.outputs.date }}
        body: |
          Daily Intel PCN database update for ${{ steps.date.outputs.date }}
          
          This release contains the latest Intel PCN Data
          
          **Database Stats:**
          - Generated: ${{ steps.date.outputs.date }}
          - File: `pcn.db` (SQLite database)
          
          **Usage:**
          - Download `pcn.db` to query PCN data locally
          - Website: [Intel PCN Database](https://intel.pcn.captnemo.in/)
        files: |
          pcn.db
        generate_release_notes: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Trigger Netlify build
      if: steps.create_release.conclusion == 'success'
      run: |
        curl -X POST -d {} "${{ secrets.NETLIFY_BUILD_URL }}"